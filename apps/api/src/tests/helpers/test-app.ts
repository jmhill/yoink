import {
  bootstrapApp,
  createInfrastructure,
} from '../../composition-root.js';
import { runMigrations } from '../../database/migrator.js';
import { migrations } from '../../database/migrations.js';
import type { AppConfig } from '../../config/schema.js';
import {
  createInjectClient,
  createFetchClient,
  type HttpClient,
} from './http-client.js';

// Test token: the composed tokenId:secret that works with the seeded auth data
// The tokenId is the first ID generated by the sequential ID generator
const TEST_TOKEN_ID = '00000000-0000-4000-8000-000000000001';
const TEST_TOKEN_SECRET = 'test-token-for-acceptance';
export const TEST_TOKEN = `${TEST_TOKEN_ID}:${TEST_TOKEN_SECRET}`;

// Test org uses the hardcoded SEED_ORG_ID from seed.ts
export const TEST_ORG_ID = '550e8400-e29b-41d4-a716-446655440001';

// Test user uses the hardcoded SEED_USER_ID from seed.ts
export const TEST_USER_ID = '550e8400-e29b-41d4-a716-446655440002';

// Admin test credentials
export const TEST_ADMIN_PASSWORD = 'test-admin-password';
export const TEST_SESSION_SECRET = 'test-session-secret-32-chars-min!';

const testConfig: AppConfig = {
  server: { port: 3000, host: '0.0.0.0' },
  database: { type: 'memory' },
  infrastructure: {
    clock: {
      type: 'fake',
      startTime: new Date('2025-01-15T10:00:00.000Z'),
      autoAdvanceMs: 1000, // Advance 1 second on each call for ordering tests
    },
    idGenerator: { type: 'sequential' },
    passwordHasher: { type: 'fake' },
  },
  seedToken: TEST_TOKEN_SECRET,
};

const testConfigWithAdmin: AppConfig = {
  ...testConfig,
  admin: {
    password: TEST_ADMIN_PASSWORD,
    sessionSecret: TEST_SESSION_SECRET,
  },
};

/**
 * Creates an in-process Fastify app for testing.
 * @deprecated Use createTestContext() for new tests
 */
export const createTestApp = async () => {
  // In tests, we run migrations before creating the app
  // In production, migrations are run as a separate CI/CD step
  const infrastructure = createInfrastructure(testConfig);
  runMigrations(infrastructure.database.db, migrations);

  return bootstrapApp({ config: testConfig, infrastructure, silent: true });
};

/**
 * Creates an in-process Fastify app with admin routes enabled.
 * @deprecated Use createTestContext() for new tests
 */
export const createTestAppWithAdmin = async () => {
  // In tests, we run migrations before creating the app
  // In production, migrations are run as a separate CI/CD step
  const infrastructure = createInfrastructure(testConfigWithAdmin);
  runMigrations(infrastructure.database.db, migrations);

  return bootstrapApp({
    config: testConfigWithAdmin,
    infrastructure,
    silent: true,
  });
};

/**
 * Test context containing HTTP client and credentials.
 * Works in both in-process and external container modes.
 */
export type TestContext = {
  client: HttpClient;
  adminPassword: string;
  /**
   * Pre-seeded API token (only available in in-process mode).
   * For external mode, create a tenant via admin API instead.
   */
  seedToken?: string;
};

/**
 * Creates a test context that works in both modes:
 * - In-process mode (default): Spins up a Fastify app, uses inject
 * - External mode (TEST_BASE_URL set): Uses fetch to call external container
 *
 * @example
 * // In-process mode (pnpm quality)
 * const { client, adminPassword } = await createTestContext();
 *
 * @example
 * // External mode (e2e tests against container)
 * // Set TEST_BASE_URL=http://localhost:3333
 * // Set TEST_ADMIN_PASSWORD=test-admin-password
 * const { client, adminPassword } = await createTestContext();
 */
export const createTestContext = async (): Promise<TestContext> => {
  const baseUrl = process.env.TEST_BASE_URL;

  if (baseUrl) {
    // External container mode - use fetch client
    const adminPassword = process.env.TEST_ADMIN_PASSWORD;
    if (!adminPassword) {
      throw new Error(
        'TEST_ADMIN_PASSWORD must be set when using TEST_BASE_URL'
      );
    }

    return {
      client: createFetchClient(baseUrl),
      adminPassword,
      // No seed token in external mode - create tenant via admin API
    };
  }

  // In-process mode - spin up app and use inject client
  const infrastructure = createInfrastructure(testConfigWithAdmin);
  runMigrations(infrastructure.database.db, migrations);

  const app = await bootstrapApp({
    config: testConfigWithAdmin,
    infrastructure,
    silent: true,
  });

  return {
    client: createInjectClient(app),
    adminPassword: TEST_ADMIN_PASSWORD,
    seedToken: TEST_TOKEN,
  };
};
