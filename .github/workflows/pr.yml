name: PR

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - "AGENTS.md"
      - "CLAUDE.md"
      - ".github/workflows/claude*.yml"

concurrency:
  group: pr-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0

      - name: Setup pnpm cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup turbo cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: devbox run pnpm install --frozen-lockfile

      - name: Run quality checks
        run: devbox run pnpm quality

      - name: Security audit
        run: devbox run pnpm audit --audit-level=high

  build-and-test:
    name: Build & E2E Tests
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          file: apps/api/Dockerfile
          load: true
          tags: yoink-api:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0

      - name: Setup pnpm cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup turbo cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install acceptance test dependencies
        run: devbox run pnpm install --frozen-lockfile --filter @yoink/acceptance-tests...

      - name: Cache Playwright browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: devbox run pnpm --filter @yoink/acceptance-testing exec playwright install chromium

      - name: Run E2E tests
        run: |
          IMAGE=yoink-api:pr-${{ github.event.pull_request.number }} \
          CI=true \
          devbox run ./scripts/e2e-test.sh

      - name: Generate Feature Report
        if: always()
        run: |
          REPORT_FILE="packages/acceptance-tests/test-report.md"
          if [ -f "$REPORT_FILE" ]; then
            echo "## Acceptance Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests run against Docker container with **HTTP + Playwright drivers**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          fi

  extension:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Check for extension changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            extension:
              - 'apps/extension/**'
              - 'packages/api-contracts/**'

      - name: Install devbox
        if: steps.filter.outputs.extension == 'true'
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0

      - name: Setup pnpm cache
        if: steps.filter.outputs.extension == 'true'
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        if: steps.filter.outputs.extension == 'true'
        run: devbox run pnpm install --frozen-lockfile

      - name: Run extension tests
        if: steps.filter.outputs.extension == 'true'
        run: devbox run pnpm --filter @yoink/extension test

      - name: Build extension
        if: steps.filter.outputs.extension == 'true'
        run: devbox run pnpm --filter @yoink/extension... build
