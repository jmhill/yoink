name: Trunk

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - "AGENTS.md"
      - "CLAUDE.md"
      - ".github/workflows/claude*.yml"

concurrency:
  group: trunk-${{ github.sha }}
  cancel-in-progress: false

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0

      - name: Setup pnpm cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: devbox run pnpm install --frozen-lockfile

      - name: Run quality checks
        run: devbox run pnpm quality

      - name: Security audit
        run: devbox run pnpm audit --audit-level=high

  build-artifact:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@63da3ecc5e2793b98a3f2519b3d75d4f4c11cec2 # master

      - name: Authenticate with Fly.io Registry
        run: flyctl auth docker
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: registry.fly.io/jhtc-yoink-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_SENTRY_DSN=${{ secrets.SENTRY_DSN }}

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build-artifact

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Install devbox
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0

      - name: Setup pnpm cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@63da3ecc5e2793b98a3f2519b3d75d4f4c11cec2 # master

      - name: Authenticate with Fly.io Registry
        run: flyctl auth docker
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Pull pre-built image
        run: docker pull registry.fly.io/jhtc-yoink-api:${{ github.sha }}

      - name: Install and build acceptance test dependencies
        run: |
          devbox run pnpm install --frozen-lockfile --filter @yoink/acceptance-tests...
          devbox run pnpm --filter @yoink/acceptance-testing build

      - name: Cache Playwright browsers
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: devbox run pnpm --filter @yoink/acceptance-testing exec playwright install chromium

      - name: Run E2E tests
        run: |
          IMAGE=registry.fly.io/jhtc-yoink-api:${{ github.sha }} \
          CI=true \
          devbox run ./scripts/e2e-test.sh

      - name: Generate Feature Report
        if: always()
        run: |
          REPORT_FILE="packages/acceptance-tests/test-report.md"
          if [ -f "$REPORT_FILE" ]; then
            echo "## Acceptance Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests run against Docker container with **HTTP + Playwright drivers**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          fi

  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: e2e-tests

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@63da3ecc5e2793b98a3f2519b3d75d4f4c11cec2 # master

      - name: Deploy pre-built image
        run: flyctl deploy --image registry.fly.io/jhtc-yoink-api:${{ github.sha }} --config apps/api/fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  smoke-test:
    name: Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 10

      - name: Health check with retry
        run: |
          API_URL="https://jhtc-yoink-api.fly.dev"
          MAX_RETRIES=5
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i: Checking health..."
            HTTP_CODE=$(curl -s -o /tmp/health.json -w "%{http_code}" "$API_URL/api/health")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed!"
              cat /tmp/health.json
              exit 0
            fi

            echo "Health check returned $HTTP_CODE, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Create test capture
        env:
          SMOKE_TEST_TOKEN: ${{ secrets.SMOKE_TEST_TOKEN }}
        run: |
          API_URL="https://jhtc-yoink-api.fly.dev"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Skip if token not configured (first deploy)
          if [ -z "$SMOKE_TEST_TOKEN" ]; then
            echo "SMOKE_TEST_TOKEN not configured - skipping capture test"
            echo "After first deploy, add SMOKE_TEST_TOKEN secret from Fly.io logs"
            exit 0
          fi

          HTTP_CODE=$(curl -s -o /tmp/capture.json -w "%{http_code}" \
            -X POST "$API_URL/api/captures" \
            -H "Authorization: Bearer $SMOKE_TEST_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"Smoke test at $TIMESTAMP\", \"sourceApp\": \"github-actions\"}")

          if [ "$HTTP_CODE" = "201" ]; then
            echo "Capture creation passed!"
            cat /tmp/capture.json
          else
            echo "Capture creation failed with status $HTTP_CODE"
            cat /tmp/capture.json
            exit 1
          fi

      - name: Verify admin UI reachable
        run: |
          ADMIN_HTML=$(curl -sf https://jhtc-yoink-api.fly.dev/admin/)
          
          # Check that HTML is returned
          echo "$ADMIN_HTML" | grep -q "<!DOCTYPE html>" || { echo "No HTML returned"; exit 1; }
          
          # Check that it's the admin app (has the expected title)
          echo "$ADMIN_HTML" | grep -q "Yoink Admin" || { echo "Admin title not found - may be serving wrong page"; exit 1; }
          
          # Verify JS and CSS assets are referenced (basic sanity check)
          echo "$ADMIN_HTML" | grep -q "/admin/assets/" || { echo "Admin assets not referenced"; exit 1; }
          
          echo "Admin UI is reachable and contains expected content"

  extension-build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: quality

    outputs:
      should-release: ${{ steps.filter.outputs.extension == 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v4

      - name: Check for extension changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            extension:
              - 'apps/extension/**'
              - 'packages/api-contracts/**'

      - name: Install devbox
        if: steps.filter.outputs.extension == 'true'
        uses: jetify-com/devbox-install-action@a0d2d53632934ae004f878c840055956d9f741b0 # v0.14.0

      - name: Setup pnpm cache
        if: steps.filter.outputs.extension == 'true'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        if: steps.filter.outputs.extension == 'true'
        run: devbox run pnpm install --frozen-lockfile

      - name: Run extension tests
        if: steps.filter.outputs.extension == 'true'
        run: devbox run pnpm --filter @yoink/extension test

      - name: Build extension
        if: steps.filter.outputs.extension == 'true'
        run: devbox run pnpm --filter @yoink/extension... build

      - name: Package extension
        if: steps.filter.outputs.extension == 'true'
        run: |
          cd apps/extension/dist
          zip -r ../../../yoink-extension.zip .

      - name: Upload extension artifact
        if: steps.filter.outputs.extension == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        with:
          name: yoink-extension-${{ github.sha }}
          path: yoink-extension.zip
          retention-days: 30

  extension-release:
    name: Release Extension
    runs-on: ubuntu-latest
    needs: extension-build
    if: needs.extension-build.outputs.should-release == 'true'

    permissions:
      contents: write

    steps:
      - name: Download extension artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          name: yoink-extension-${{ github.sha }}

      - name: Generate version tag
        id: version
        run: |
          VERSION=$(date -u +"%Y%m%d-%H%M%S")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: extension-${{ steps.version.outputs.version }}
          name: Extension ${{ steps.version.outputs.version }}
          body: |
            Browser extension build from commit ${{ github.sha }}

            ## Installation
            1. Download `yoink-extension.zip` below
            2. Unzip to a permanent location
            3. Open Chrome and go to `chrome://extensions`
            4. Enable "Developer mode" (top right toggle)
            5. Click "Load unpacked" and select the unzipped folder
          files: yoink-extension.zip
          generate_release_notes: false
