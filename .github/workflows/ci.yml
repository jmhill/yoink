name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'AGENTS.md'
      - 'CLAUDE.md'
      - '.github/workflows/claude*.yml'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'AGENTS.md'
      - 'CLAUDE.md'
      - '.github/workflows/claude*.yml'

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install devbox
        uses: jetify-com/devbox-install-action@v0.14.0

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(devbox run pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: devbox run pnpm install --frozen-lockfile

      - name: Run quality checks
        run: devbox run pnpm quality

  build-artifact:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Authenticate with Fly.io Registry
        run: flyctl auth docker
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/api/Dockerfile
          push: true
          tags: registry.fly.io/jhtc-yoink-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build-artifact

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install devbox
        uses: jetify-com/devbox-install-action@v0.14.0

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(devbox run pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Authenticate with Fly.io Registry
        run: flyctl auth docker
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Pull pre-built image
        run: docker pull registry.fly.io/jhtc-yoink-api:${{ github.sha }}

      - name: Install acceptance test dependencies
        run: devbox run pnpm install --frozen-lockfile --filter @yoink/acceptance-tests

      - name: Run E2E tests
        run: |
          IMAGE=registry.fly.io/jhtc-yoink-api:${{ github.sha }} \
          CI=true \
          devbox run ./scripts/e2e-test.sh

      - name: Generate Feature Report
        if: always()
        run: |
          RESULTS_FILE="packages/acceptance-tests/test-results.json"
          if [ -f "$RESULTS_FILE" ]; then
            echo "## ðŸ§ª Acceptance Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Tests run against Docker container with **HTTP driver**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('$RESULTS_FILE', 'utf8'));
            
            const driver = process.env.DRIVER || 'http';
            
            console.log('| Feature | Tests | Status | Driver |');
            console.log('|---------|-------|--------|--------|');
            
            for (const file of results.testResults) {
                const name = file.name.split('/').pop().replace('.test.ts', '').replace(/-/g, ' ');
                const featureName = name.charAt(0).toUpperCase() + name.slice(1);
                const passed = file.assertionResults.filter(t => t.status === 'passed').length;
                const total = file.assertionResults.length;
                const status = passed === total ? 'âœ… Pass' : 'âŒ Fail';
                console.log('| ' + featureName + ' | ' + passed + '/' + total + ' | ' + status + ' | ' + driver + ' |');
            }
            
            console.log('');
            const totalPassed = results.numPassedTests;
            const totalTests = results.numTotalTests;
            const allPassed = totalPassed === totalTests;
            console.log('### ' + (allPassed ? 'âœ…' : 'âŒ') + ' Total: ' + totalPassed + '/' + totalTests + ' tests passed');
            " >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“‹ Detailed Test Results</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('$RESULTS_FILE', 'utf8'));
            
            for (const file of results.testResults) {
                const name = file.name.split('/').pop().replace('.test.ts', '').replace(/-/g, ' ');
                const featureName = name.charAt(0).toUpperCase() + name.slice(1);
                console.log('#### ' + featureName);
                console.log('');
                
                for (const test of file.assertionResults) {
                    const icon = test.status === 'passed' ? 'âœ…' : 'âŒ';
                    const title = test.title;
                    console.log('- ' + icon + ' ' + title);
                }
                console.log('');
            }
            " >> $GITHUB_STEP_SUMMARY
            
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy pre-built image
        run: flyctl deploy --image registry.fly.io/jhtc-yoink-api:${{ github.sha }} --config apps/api/fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

  smoke-test:
    name: Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Wait for deployment to stabilize
        run: sleep 10

      - name: Health check with retry
        run: |
          API_URL="https://jhtc-yoink-api.fly.dev"
          MAX_RETRIES=5
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i: Checking health..."
            HTTP_CODE=$(curl -s -o /tmp/health.json -w "%{http_code}" "$API_URL/api/health")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "Health check passed!"
              cat /tmp/health.json
              exit 0
            fi

            echo "Health check returned $HTTP_CODE, retrying in ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
            RETRY_DELAY=$((RETRY_DELAY * 2))
          done

          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Create test capture
        env:
          SMOKE_TEST_TOKEN: ${{ secrets.SMOKE_TEST_TOKEN }}
        run: |
          API_URL="https://jhtc-yoink-api.fly.dev"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Skip if token not configured (first deploy)
          if [ -z "$SMOKE_TEST_TOKEN" ]; then
            echo "SMOKE_TEST_TOKEN not configured - skipping capture test"
            echo "After first deploy, add SMOKE_TEST_TOKEN secret from Fly.io logs"
            exit 0
          fi

          HTTP_CODE=$(curl -s -o /tmp/capture.json -w "%{http_code}" \
            -X POST "$API_URL/api/captures" \
            -H "Authorization: Bearer $SMOKE_TEST_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"content\": \"Smoke test at $TIMESTAMP\", \"sourceApp\": \"github-actions\"}")

          if [ "$HTTP_CODE" = "201" ]; then
            echo "Capture creation passed!"
            cat /tmp/capture.json
          else
            echo "Capture creation failed with status $HTTP_CODE"
            cat /tmp/capture.json
            exit 1
          fi

      - name: Verify admin UI reachable
        run: |
          curl -sf https://jhtc-yoink-api.fly.dev/admin/ | grep -q "<!DOCTYPE html>"
          echo "Admin UI is reachable"
