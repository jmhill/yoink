services:
  api:
    # Use pre-built image if IMAGE is set, otherwise build from Dockerfile
    image: ${IMAGE:-}
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    environment:
      - ADMIN_PASSWORD=test-admin-password
      - SESSION_SECRET=test-session-secret-min-32-chars-long
      - SKIP_LITESTREAM=true
      - DB_PATH=/app/apps/api/data/captures.db
      # Disable rate limiting for E2E tests
      - RATE_LIMIT_ENABLED=false
      # Disable secure cookies (we test over HTTP, not HTTPS)
      - COOKIE_SECURE=false
      # WebAuthn configuration for passkey testing
      - WEBAUTHN_RP_ID=localhost
      - WEBAUTHN_RP_NAME=Yoink Test
      - WEBAUTHN_ORIGIN=http://localhost:3333
      - WEBAUTHN_CHALLENGE_SECRET=test-challenge-secret-min-32-chars-long-for-hmac
    ports:
      - "3333:3000"
    volumes:
      # Persist database between migration run and app start
      - db-data:/app/apps/api/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 5s

volumes:
  db-data:
